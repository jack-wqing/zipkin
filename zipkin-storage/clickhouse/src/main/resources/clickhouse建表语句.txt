测试基本表
CREATE TABLE log.zipkin_spans
(
    `traceId` String,
    `parentId` String,
    `id` String,
    `kind` String,
    `duration` UInt32,
    `name` String,
    `timestamp` String,
    `status` String,
    `timestampMillis` UInt64,
    `localEndpointIpv4` String,
    `localEndpointServiceName` String,
    `localEndpointPort` String,
    `remoteEndpointIpv4` String,
    `remoteEndpointServiceName` String,
    `remoteEndpointPort` String,
    `tagsRpcMethod` String,
    `tagsRpcService` String,
    `tagsAppname` String,
    `tagsComponent` String,
    `tagsHttpUrl` String,
    `tagsHttpMethod` String,
    `tagsCatMessageId` String,
    `tagsHttpPath` String,
    `tagsHttpRequestSize` UInt32,
    `tagsHttpResponseSize` UInt32,
    `tagsHttpStatusCode` UInt32,
    `tagsLocalIpv4` String,
    `tagsPeerIpv4` String,
    `tagsPeerService` String,
    `tagsPeerPort` UInt32,
    `tagsPeerHostname` String,
    `tagsPeerIpv6` String,
    `tagsProcessId` UInt32,
    `tagsSpanKind` String,
    `tagsWorkerId` UInt32,
    `logFilePath` String,
    `time` DateTime,
    `tagsSql` String
)
ENGINE = MergeTree
PARTITION BY toYYYYMMDD(time)
ORDER BY (time,localEndpointServiceName)
TTL time + toIntervalDay(7)
SETTINGS index_granularity = 8192;

分布式表:
CREATE TABLE log.zipkin_spans_dist
(
    `traceId` String,
    `parentId` String,
    `id` String,
    `kind` String,
    `duration` UInt32,
    `name` String,
    `timestamp` String,
    `status` String,
    `timestampMillis` UInt64,
    `localEndpointIpv4` String,
    `localEndpointServiceName` String,
    `localEndpointPort` String,
    `remoteEndpointIpv4` String,
    `remoteEndpointServiceName` String,
    `remoteEndpointPort` String,
    `tagsRpcMethod` String,
    `tagsRpcService` String,
    `tagsAppname` String,
    `tagsComponent` String,
    `tagsHttpUrl` String,
    `tagsHttpMethod` String,
    `tagsCatMessageId` String,
    `tagsHttpPath` String,
    `tagsHttpRequestSize` UInt32,
    `tagsHttpResponseSize` UInt32,
    `tagsHttpStatusCode` UInt32,
    `tagsLocalIpv4` String,
    `tagsPeerIpv4` String,
    `tagsPeerService` String,
    `tagsPeerPort` UInt32,
    `tagsPeerHostname` String,
    `tagsPeerIpv6` String,
    `tagsProcessId` UInt32,
    `tagsSpanKind` String,
    `tagsWorkerId` UInt32,
    `logFilePath` String,
    `time` DateTime,
    `tagsSql` String
)
ENGINE = Distributed('cluster_log', 'log', 'zipkin_spans', rand());

trace场景索引:
CREATE TABLE log.zipkin_spans_trace
(
    `traceId` String,
    `parentId` String,
    `id` String,
    `kind` String,
    `duration` UInt32,
    `name` String,
    `timestamp` String,
    `status` String,
    `timestampMillis` UInt64,
    `localEndpointIpv4` String,
    `localEndpointServiceName` String,
    `localEndpointPort` String,
    `remoteEndpointIpv4` String,
    `remoteEndpointServiceName` String,
    `remoteEndpointPort` String,
    `tagsRpcMethod` String,
    `tagsRpcService` String,
    `tagsAppname` String,
    `tagsComponent` String,
    `tagsHttpUrl` String,
    `tagsHttpMethod` String,
    `tagsCatMessageId` String,
    `tagsHttpPath` String,
    `tagsHttpRequestSize` UInt32,
    `tagsHttpResponseSize` UInt32,
    `tagsHttpStatusCode` UInt32,
    `tagsLocalIpv4` String,
    `tagsPeerIpv4` String,
    `tagsPeerService` String,
    `tagsPeerPort` UInt32,
    `tagsPeerHostname` String,
    `tagsPeerIpv6` String,
    `tagsProcessId` UInt32,
    `tagsSpanKind` String,
    `tagsWorkerId` UInt32,
    `logFilePath` String,
    `time` DateTime,
    `tagsSql` String
)
ENGINE = MergeTree
PARTITION BY toYYYYMMDD(time)
ORDER BY (traceId)
TTL time + toIntervalDay(7)
SETTINGS index_granularity = 8192;
物化视图分布式表
CREATE TABLE log.zipkin_spans_trace_dist
(
    `traceId` String,
    `parentId` String,
    `id` String,
    `kind` String,
    `duration` UInt32,
    `name` String,
    `timestamp` String,
    `status` String,
    `timestampMillis` UInt64,
    `localEndpointIpv4` String,
    `localEndpointServiceName` String,
    `localEndpointPort` String,
    `remoteEndpointIpv4` String,
    `remoteEndpointServiceName` String,
    `remoteEndpointPort` String,
    `tagsRpcMethod` String,
    `tagsRpcService` String,
    `tagsAppname` String,
    `tagsComponent` String,
    `tagsHttpUrl` String,
    `tagsHttpMethod` String,
    `tagsCatMessageId` String,
    `tagsHttpPath` String,
    `tagsHttpRequestSize` UInt32,
    `tagsHttpResponseSize` UInt32,
    `tagsHttpStatusCode` UInt32,
    `tagsLocalIpv4` String,
    `tagsPeerIpv4` String,
    `tagsPeerService` String,
    `tagsPeerPort` UInt32,
    `tagsPeerHostname` String,
    `tagsPeerIpv6` String,
    `tagsProcessId` UInt32,
    `tagsSpanKind` String,
    `tagsWorkerId` UInt32,
    `logFilePath` String,
    `time` DateTime,
    `tagsSql` String
)
ENGINE = Distributed('cluster_log', 'log', 'zipkin_spans_trace', rand());


数据迁移sql
INSERT INTO log.zipkin_spans SELECT
    traceId AS traceId,
    parentId AS parentId,
    id AS id,
    kind AS kind,
    toUInt32OrZero(duration) AS duration,
    name AS name,
    timestamp AS timestamp,
    status AS status,
    timestampMillis AS timestampMillis,
    localEndpointIpv4 AS localEndpointIpv4,
    localEndpointServiceName AS localEndpointServiceName,
    localEndpointPort AS localEndpointPort,
    remoteEndpointIpv4 AS remoteEndpointIpv4,
    remoteEndpointServiceName AS remoteEndpointServiceName,
    remoteEndpointPort AS remoteEndpointPort,
    tagsRpcMethod AS tagsRpcMethod,
    tagsRpcService AS tagsRpcService,
    tagsAppname AS tagsAppname,
    tagsComponent AS tagsComponent,
    tagsHttpUrl AS tagsHttpUrl,
    tagsHttpMethod AS tagsHttpMethod,
    tagsCatMessageId AS tagsCatMessageId,
    tagsHttpPath AS tagsHttpPath,
    tagsHttpRequestSize AS tagsHttpRequestSize,
    tagsHttpResponseSize AS tagsHttpResponseSize,
    tagsHttpStatusCode AS tagsHttpStatusCode,
    tagsLocalIpv4 AS tagsLocalIpv4,
    tagsPeerIpv4 AS tagsPeerIpv4,
    tagsPeerService AS tagsPeerService,
    tagsPeerPort AS tagsPeerPort,
    tagsPeerHostname AS tagsPeerHostname,
    tagsPeerIpv6 AS tagsPeerIpv6,
    tagsProcessId AS tagsProcessId,
    tagsSpanKind AS tagsSpanKind,
    tagsWorkerId AS tagsWorkerId,
    logFilePath AS logFilePath,
    time AS time,
    tagsSql AS tagsSql
FROM remote('10.100.5.161:9000', 'log', 'zipkin_prod') AS t
ORDER BY time DESC

创建物化视图
CREATE MATERIALIZED VIEW log.zipkin_spans_trace_dist_mv TO log.zipkin_spans_trace_dist AS
SELECT traceId AS traceId,
       parentId AS parentId,
       id AS id,
       kind AS kind,
       duration AS duration,
       name AS name,
       timestamp AS timestamp,
       status AS status,
       timestampMillis AS timestampMillis,
       localEndpointIpv4 AS localEndpointIpv4,
       localEndpointServiceName AS localEndpointServiceName,
       localEndpointPort AS localEndpointPort,
       remoteEndpointIpv4 AS remoteEndpointIpv4,
       remoteEndpointServiceName AS remoteEndpointServiceName,
       remoteEndpointPort AS remoteEndpointPort,
       tagsRpcMethod AS tagsRpcMethod,
       tagsRpcService AS tagsRpcService,
       tagsAppname AS tagsAppname,
       tagsComponent AS tagsComponent,
       tagsHttpUrl AS tagsHttpUrl,
       tagsHttpMethod AS tagsHttpMethod,
       tagsCatMessageId AS tagsCatMessageId,
       tagsHttpPath AS tagsHttpPath,
       tagsHttpRequestSize AS tagsHttpRequestSize,
       tagsHttpResponseSize AS tagsHttpResponseSize,
       tagsHttpStatusCode AS tagsHttpStatusCode,
       tagsLocalIpv4 AS tagsLocalIpv4,
       tagsPeerIpv4 AS tagsPeerIpv4,
       tagsPeerService AS tagsPeerService,
       tagsPeerPort AS tagsPeerPort,
       tagsPeerHostname AS tagsPeerHostname,
       tagsPeerIpv6 AS tagsPeerIpv6,
       tagsProcessId AS tagsProcessId,
       tagsSpanKind AS tagsSpanKind,
       tagsWorkerId AS tagsWorkerId,
       logFilePath AS logFilePath,
       time AS time,
       tagsSql AS tagsSql
FROM log.zipkin_spans_dist;
